---
title: 'Create Blood Bowl roster plots'
author: "Gertjan Verhoeven"
date: '2023-01-20'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

# Fetching the FUMBBL roster data using Python

I'll keep the grueling data collection and preparation part short. We build on previous work where I used web scraping to build a database of matches played on FUMBBL. Now I added the chosen tournament skills, available through the API at the team level as JSON data. 

This dataset allows us to identify the teams that participated in the online NAF tournament. 
The **NAF Online Tournaments** FUMBBL group (group id 9298) contains the Road To Malta tournament:

```{r}
df_matches <- read.csv(file = "../../../../fumbbl_datasets/datasets/current/df_matches.csv")
df_matches$match_date <- as.Date(df_matches$match_date)
df_matches$week_date <- as.Date(df_matches$week_date)
```

```{r}
res <- df_matches %>%
  filter(group_id == 9298) %>%
  group_by(division_name, tournament_id, division_id, group_id, current_ruleset) %>%
  summarise(cnt = n(), start_date = min(match_date), end_date = max(match_date)) %>%
  filter(start_date > as.Date("2022-08-01")) %>%
  arrange(-tournament_id)

res
```

So we need the team rosters (identified by a `team_id`) associated with four tournament ids: 58321, 58322, 58323 and 58324.

Given these `team_ids`, I wrote a custom Python script `get_team_roster.py` called from a Jupyter notebook (part of the `fumbbl_datasets` Github repository) that pieces the complete rosters together. This includes the players, but also things like rerolls, apothecary, induced Star Players as well as skills assigned. Full code is in the `fumbbl_datasets` Github repository.  

# Creating the plots

I switched to R For further processing of the data (including clustering) and creating the final roster visualizations. Full code is available in `create_plots.Rmd`. Processing of the data involved:

* adding the cost for each player and inducement (yes, I typed together a file with the cost of all the BB2020 rosters!), 
* creating a table with all the skill colors, 
* removing the bribes from the inducements that originated from the "Get the ref" kickoff event (but keeping those that are part of the roster)
* applying a hierarchical clustering algorithm (`hclust_order()` from my own wrapper package `ggoheatmap`) to create a sort order for the rosters.

I used `ggplot` create the final plots. For ease of sharing, I created `roster_book.Rmd` that generates a PDF that contains all 29 plots.

# Load packages

```{r warning=FALSE, message=FALSE}
# Load packages
library(tidyverse)
library(ggfortify)
library(ggrepel)
library(readODS)
```


# Read and prep the data

We start with reading in the scraped FUMBBL roster data, this is generated by the `fumbbl_rosters` Jupyter Notebook.

<!--
```{r}
df_rosters1 <- read.csv(file = "../../../../fumbbl_datasets/datasets/current/df_rosters_road_to_malta.csv")
df_rosters2 <- read.csv(file = "../../../../fumbbl_datasets/datasets/current/df_rosters_super_league.csv")
df_rosters3 <- read.csv(file = "../../../../fumbbl_datasets/datasets/current/df_rosters_wc_training.csv")

df_rosters1$group_name <- "Road to Malta"
df_rosters2$group_name <- "super_league"
df_rosters3$group_name <- "WC training"

group_name <- "1150K"

df_rosters <- rbind(df_rosters1, df_rosters2, df_rosters3) %>%
  filter(position != "") %>%
  mutate(cnt = 1) %>%
  rename(skill_name = name)
```
--->

```{r}
df_rosters1 <- read.csv(file = "../../../../fumbbl_datasets/datasets/current/df_rosters_road_to_malta.csv")

df_rosters1$group_name <- "Road to Malta"

group_name <- "Road to Malta"

df_rosters <- df_rosters1 %>%
  filter(position != "") %>%
  mutate(cnt = 1) %>%
  rename(skill_name = name)
```

```{r}
# add xtra stuff
extra_stuff <- unique(df_rosters %>% 
                    mutate(apothecary = ifelse(apothecary == "Yes", 1, 0)) %>%
  select(group_name, team_id, roster.name, coach_name, rerolls, assistantCoaches, cheerleaders, apothecary) %>%
    pivot_longer(cols = -c(group_name, team_id, roster.name, coach_name), values_to = "cnt") %>%
    filter(cnt > 0) %>%
    mutate(position = name) %>%
    select(group_name, team_id, roster.name, coach_name, position, cnt) %>%
    mutate(player_id = 99999999) %>%
    mutate(number = 99) %>%
    mutate(skill_id = NA) %>%
    mutate(name = NA)) %>%
    rename(skill_name = name)

df_rosters <- df_rosters %>%
  select(-c(X, rerolls, assistantCoaches, cheerleaders, apothecary))

df_rosters <- rbind(df_rosters, extra_stuff)


```

# filter out BB2016 teams (Bretonnian)


```{r}
df_rosters <- df_rosters %>%
  filter(roster.name != "Bretonnian")
```

# Label old and new amazon, and old and new norse rosters

amazon team with old/new mix 5141 roster. roster contains positionals from old and new!!!

```{r}
# drop old amazon team in WC training
df_rosters <- df_rosters %>%
  filter(team_id != 836802)
```


```{r}
 old_amazon_team_ids <- df_rosters %>% filter(position == "Koka Kalim Blitzer") %>%
  filter(roster.name != "Amazon Eurobowl 2022") %>%
  group_by(team_id) %>%
  summarise(n()) %>%
  pull(team_id)
```   

```{r}
df_rosters <- df_rosters %>% 
  mutate(roster.name = ifelse(team_id %in% old_amazon_team_ids, "Amazon Team of Legend", roster.name))
```

There are also rosters with Norse Catcher AND Norse Raider. (old/new) march 2022, roster id 5144. This roster contains 

```{r}
 old_norse_team_ids <- df_rosters %>% filter(position %in% c("Norse Thrower", "Norse Catcher", "Norse Lineman")) %>%
  filter(roster.name != "Norse Eurobowl 2022") %>%
  group_by(team_id) %>%
  summarise(n()) %>%
  pull(team_id)
```

```{r}
df_rosters <- df_rosters %>% 
  mutate(roster.name = ifelse(team_id %in% old_norse_team_ids, "Norse Teams of Legend", roster.name))
```


```{r}
df_rosters %>% 
  filter(grepl("Amazon", roster.name)) %>%
  group_by(roster.name, position) %>%
  summarise(n = n())
```

# Check rosters without skills

```{r}
df_rosters %>%
  mutate(w_skill = ifelse(skill_name %in% c("", NA), 0, 1)) %>%
  group_by(group_name, team_id) %>%
  summarise(n_skills = sum(w_skill)) %>%
  mutate(has_skills = ifelse(n_skills == 0, 0, 1)) %>%
  group_by(group_name) %>%
  summarise(perc = mean(has_skills))
```
So the superleague has missing skills.
Hypothesis : teams that only played in round 0 Q2 2022 have missing skills?

# Drop teams without skills.

```{r}
teams_to_drop <- df_rosters %>%
  mutate(w_skill = ifelse(skill_name %in% c("", NA), 0, 1)) %>%
  group_by(group_name, team_id) %>%
  summarise(n_skills = sum(w_skill)) %>%
  filter(n_skills == 0) %>%
  pull(team_id)

```
```{r}
df_rosters <- df_rosters %>%
  filter(!(team_id %in% teams_to_drop))
```


# Cleanup the skill names

```{r}
df_rosters <- df_rosters %>%
  mutate(skill_name = str_replace_all(skill_name, 
            pattern = "^_", replacement = "")) %>%
  mutate(skill_name = replace_na(skill_name, ""))
```


# condense skill stacking rows

A player with two skills has two rows, collapse into one, concatenating the two skills.
We sort by skill_id to avoid mirror combinations.

```{r}
df_rosters <- df_rosters %>%
  arrange(player_id, -skill_id) %>%
  group_by(across(c(-skill_id, -skill_name))) %>%
  summarise(skill_name = paste(skill_name, collapse = ""))

```
# wrangle bribes into cnt 0-3 bribes

Cannot easily seperate out the GEt the ref bribes from the  roster bribes

```{r}
df_rosters %>% 
  ungroup() %>%
  filter(grepl("bribe", position)) %>%
  distinct(position) %>%
  pull()

```

```{r}
df_rosters <- df_rosters %>%
  mutate(cnt = ifelse(grepl("bribe", position), as.integer(substr(position, 1, 2)), cnt)) %>%
  mutate(position = ifelse(grepl("bribes", position), "1 bribe", position)) 
```


# create color table

```{r eval = FALSE}
skill_colors <- df_rosters %>%
  group_by(skill_name) %>%
  summarise(n = n())

write_ods(skill_colors, "skill_colors.ods")
```

# Add skill color table

```{r}
skill_colors <- read_ods("230218 bb_skill_colors.ods")

skill_colors <- skill_colors %>%
  mutate(skill_name = replace_na(skill_name, "")) %>%
  select(-n)
```


# create code list with roster cost

create empty list with all roster positions for each race
```{r}

out <- df_rosters %>%
  group_by(position, roster.name) %>%
  summarise(n = n())

```
manually fill in cost and sort order

# add codelist with roster cost

```{r}
cost <- read_ods("230217_bb_rosters_cost.ods")

cost <- cost %>%
  select(-n)
```

# check for missings

check if dataset has new positionals or star players etc.

```{r}
out <- out %>% 
  left_join(cost, by = c("position", "roster.name"))
```

```{r, eval = FALSE}
write_ods(out, "bb_rosters.ods")
```


```{r}
df_rosters <- df_rosters %>%
  left_join(cost, by = c("position", "roster.name"))
```


# Check team cost

```{r}


res <- df_rosters %>%
  mutate(tot_cost = cnt * cost) %>%
  group_by(player_id, team_id, position, coach_name, roster.name, tot_cost) %>% # remove two rows per player (skill stacking)
  summarise() %>%
  group_by(team_id, coach_name, roster.name) %>%
  summarise(team_cost = sum(tot_cost)) %>%
  filter(!is.na(team_cost ))

res %>% filter(team_cost > 1150)

```

# remove bribes for TV >1150


all teams with 50 or 100 extra, remove 1 bribe ("get the ref" kick off result ends up on the match page)

```{r}
teams_get_the_ref <- res %>%
  filter(team_cost > 1150) %>%
  ungroup() %>%
  distinct(team_id) %>%
  pull()
```

reduce nr of bribes for get the ref teams with 1

So there are 22 get the ref teams

```{r}
df_rosters %>%
  ungroup() %>%
  filter(position == "1 bribe") %>%
  summarise(sum(cnt))
```
expect 45 - 22 = 23 bribes left

```{r}
# remove the get the ref bribes

df_rosters <- df_rosters %>%
  mutate(cnt = ifelse(team_id %in% teams_get_the_ref & position == "1 bribe", cnt - 1, cnt))

```


```{r}
df_rosters %>%
  ungroup() %>%
  filter(position == "1 bribe") %>%
  summarise(sum(cnt))
```
check!

drop rows with cnt 0

```{r}
df_rosters <- df_rosters %>% 
  filter(cnt != 0)
```


# Check total team cost again

Expect all teams at max 1150 or slightly below.

```{r}


res <- df_rosters %>%
  mutate(tot_cost = cnt * cost) %>%
  group_by(player_id, team_id, position, coach_name, roster.name, tot_cost) %>% # remove two rows per player (skill stacking)
  summarise() %>%
  group_by(team_id, coach_name, roster.name) %>%
  summarise(team_cost = sum(tot_cost)) %>%
  filter(!is.na(team_cost ))

summary(res$team_cost)

```

```{r}
res %>% filter(team_cost < 1135)
```


```{r}
df_rosters <- df_rosters %>%
  left_join(skill_colors, by = "skill_name")
```


<!-- TEST CODE FOR CLUSTERING -->
# Hierarchical clustering

dataprep for HC.

```{r}
  df <- df_rosters %>% 
    filter(roster.name == "Orc") %>%
    filter(!(position %in% c("cheerleaders", "assistantCoaches"))) %>%
    group_by(team_id, coach_name, player_id, position, sort_order, number, skill_name, color) %>% # skill stacking
    summarise(cnt = max(cnt), cost = max(cost)) %>%
    group_by(team_id, coach_name, player_id, position, sort_order, skill_name, color) %>%
    summarise(n = sum(cnt), cost = cost * sum(cnt)) %>%
    group_by(team_id, coach_name, position, sort_order, n) %>%
    summarise(nr = row_number(), skill_name = skill_name, color = color, cost = cost)

df
```

Check the matrix that will form the basis of the clustering through eyeballing.

```{r}
df %>% 
  ungroup() %>%
  select(team_id, position, nr, cost) %>%
  pivot_wider(
    names_from = team_id, 
    values_from = cost,
    values_fill = 0,
    values_fn = sum
  ) #%>% select(-position) 
```
Ok, so we have multiple teams per coach, so lets work with coach_name_team_id.

Ready for hierarchical clustering. We use `ggoheatmap::hclust_order()` to perform the actual clustering.

```{r}
library(ggoheatmap)

df_order <- df %>%
  mutate(position_unique = paste0(position, "_", nr)) %>%
  mutate(team_id_char = as.character(team_id)) %>%
  ungroup() %>%
  hclust_order(xvar = "team_id_char", 
               yvar = "position_unique", 
               value_var = "cost", dcast_fill = 1) %>%
  select(team_id, cluster_order) %>%
  distinct() %>%
  right_join(df, by = "team_id")
```


# Add Malta final standing

```{r}
malta_standings <- read_ods(path = "road_to_malta_standings.ods", skip = 2)

malta_standings <- malta_standings %>%
  filter(!is.na(Rank))
```


Make all names lower case before joining.

Add points in coach name.

```{r}
malta_standings$coach_name <- str_to_title(malta_standings$Coach)
df_rosters$coach_name <- str_to_title(df_rosters$coach_name)

malta_standings <- malta_standings %>% 
  mutate(across('coach_name', str_replace, 'Liam_gallagher', 'Liam'))

df_rosters <- df_rosters %>%
  left_join(malta_standings %>% select(coach_name, Points), by = "coach_name")

df_rosters$coach_name <- paste0(df_rosters$coach_name, "_", df_rosters$Points, "p")
```

   
# Create heatmap plots

```{r message = F, fig.width= 10}
races <- unique(df_rosters$roster.name)

for(i in 1:length(races)){
  race_name <- races[i]

  df <- df_rosters %>% 
    filter(roster.name == race_name) %>%
    filter(!(position %in% c("cheerleaders", "assistantCoaches"))) %>%
    group_by(team_id, coach_name, player_id, position, sort_order, number, skill_name, color) %>% # skill stacking
    summarise(cnt = max(cnt), cost = max(cost)) %>%
    group_by(team_id, coach_name, player_id, position, sort_order, skill_name, color) %>%
    summarise(n = sum(cnt), cost = cost * sum(cnt)) %>%
    group_by(team_id, coach_name, position, sort_order, n) %>%
    summarise(nr = row_number(), skill_name = skill_name, color = color, cost = cost)

  # check on at least 2 teams
  if(n_distinct(df$team_id) > 1 & n_distinct(df$cost) > 1){ # do clustering
    df <- df %>%
      mutate(position_unique = paste0(position, "_", nr)) %>%
      mutate(team_id_char = as.character(team_id)) %>%
      ungroup() %>%
      hclust_order(xvar = "team_id_char", 
                   yvar = "position_unique", 
                   value_var = "cost", dcast_fill = 1) %>%
      select(team_id, cluster_order) %>%
      distinct() %>%
      right_join(df, by = "team_id") 
  } else {
    df <- df %>%
      mutate(cluster_order = as.integer(as.factor(coach_name)))
  }
  #df$coach_team_id <- paste0(df$coach_name, "_", str_sub(as.character(df$team_id), start = -3))
  df$coach_team_id <- df$coach_name
  
  gp <- ggplot(df, aes(x = reorder(factor(coach_team_id), cluster_order), y = reorder(paste(position, nr), -sort_order))) +
    geom_tile(aes(fill = color), color = "black") +
    geom_text(aes(label = n), color = "white") +
    scale_fill_identity(name = "Skills",
                        breaks = c(skill_colors$color),
                        labels = c(skill_colors$skill_name),
                        guide = "legend") +
    #scale_fill_gradient(low = "light blue", high = "blue", na.value = "white") +
    coord_fixed() +
    #theme(legend.position = "none") +
    ggtitle(paste0("FUMBBL ", group_name, " ", race_name, " rosters")) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    theme(panel.background = element_rect(fill = "white")) +
    labs(x = "", y = "")
  
  plotname <- paste0("road_to_malta/", group_name, "_roster_plot_", race_name, ".png")
  print(plotname)
  ggsave(gsub(" ", "_", plotname), gp, width = 10)
}
```






